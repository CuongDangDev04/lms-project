INSERT INTO SINHVIEN (MSSV, TENSV, SODT, LOP, DIACHI) VALUES ('97TH01', 'Nguyen Van An', '9688543', '97TH01', '12 NTMK');
INSERT INTO SINHVIEN (MSSV, TENSV, SODT, LOP, DIACHI) VALUES ('97TH02', 'Tran Hung', '8453443', '97TH01', '13/4 LCT');
INSERT INTO SINHVIEN (MSSV, TENSV, SODT, LOP, DIACHI) VALUES ('97TH03', 'Le Thuy Hang', '8544457', '97TH01', '20 Pasteur');
INSERT INTO SINHVIEN (MSSV, TENSV, SODT, LOP, DIACHI) VALUES ('97TH04', 'Ngo Khoa', '8544539', '97TH02', '54/12 LHP');
INSERT INTO SINHVIEN (MSSV, TENSV, SODT, LOP, DIACHI) VALUES ('97TH05', 'Pham Tai', '8149023', '97TH02', '12 HBT');
INSERT INTO SINHVIEN (MSSV, TENSV, SODT, LOP, DIACHI) VALUES ('97TH06', 'Dinh Tien', '8956123', '97TH01', '31 THD');

INSERT INTO DETAI (MSDT, TENDT) VALUES ('97001', 'Quan ly thu vien');
INSERT INTO DETAI (MSDT, TENDT) VALUES ('97002', 'Nhan dang van tay');
INSERT INTO DETAI (MSDT, TENDT) VALUES ('97003', 'Ban dau gia tren mang');
INSERT INTO DETAI (MSDT, TENDT) VALUES ('97004', 'Quan ly sieu thi');
INSERT INTO DETAI (MSDT, TENDT) VALUES ('97005', 'Xur ly anh');

INSERT INTO SV_DETAI (MSSV, MSDT) VALUES ('97TH01', '97004');
INSERT INTO SV_DETAI (MSSV, MSDT) VALUES ('97TH02', '97005');
INSERT INTO SV_DETAI (MSSV, MSDT) VALUES ('97TH03', '97001');
INSERT INTO SV_DETAI (MSSV, MSDT) VALUES ('97TH04', '97002');
INSERT INTO SV_DETAI (MSSV, MSDT) VALUES ('97TH05', '97003');
INSERT INTO SV_DETAI (MSSV, MSDT) VALUES ('97TH06', '97005');

INSERT INTO HOCHAM (MSHH, TENHH) VALUES (1, 'Pho giao su');
INSERT INTO HOCHAM (MSHH, TENHH) VALUES (2, 'Giao su');

INSERT INTO GIAOVIEN (MSGV, TENGV, DIACHI, SODT, MSHHAM, NAMHH) VALUES (1, 'Nguyen Van A', '11 NVD', '8754321', 1, 1996);
INSERT INTO GIAOVIEN (MSGV, TENGV, DIACHI, SODT, MSHHAM, NAMHH) VALUES (2, 'Tran Thu Trang', '56 XVNT', '8966458', 1, 1996);
INSERT INTO GIAOVIEN (MSGV, TENGV, DIACHI, SODT, MSHHAM, NAMHH) VALUES (3, 'Le Trung', '12/5 CMTT', '8547269', 1, 1996);
INSERT INTO GIAOVIEN (MSGV, TENGV, DIACHI, SODT, MSHHAM, NAMHH) VALUES (4, 'Nguyen Thi Loan', '321 BTX', '8564724', 2, 1997);
INSERT INTO GIAOVIEN (MSGV, TENGV, DIACHI, SODT, MSHHAM, NAMHH) VALUES (5, 'Chu V Tien', '1/60 TVD', '8632184', 2, 1997);

INSERT INTO HOCVI (MSHV, TENHV) VALUES (1, 'KS');
INSERT INTO HOCVI (MSHV, TENHV) VALUES (2, 'CN');
INSERT INTO HOCVI (MSHV, TENHV) VALUES (3, 'TS');
INSERT INTO HOCVI (MSHV, TENHV) VALUES (4, 'TSKH');

INSERT INTO CHUYENNGANH (MSCN, TENCN) VALUES (1, 'He thong thong tin');
INSERT INTO CHUYENNGANH (MSCN, TENCN) VALUES (2, 'Mang');
INSERT INTO CHUYENNGANH (MSCN, TENCN) VALUES (3, 'Do hoa');
INSERT INTO CHUYENNGANH (MSCN, TENCN) VALUES (4, 'Cong nghe phan mem');

INSERT INTO GV_HV_CN (MSGV, MSHV, MSCN, NAM) VALUES (1, 1, 1, 1999);
INSERT INTO GV_HV_CN (MSGV, MSHV, MSCN, NAM) VALUES (1, 2, 1, 1998);
INSERT INTO GV_HV_CN (MSGV, MSHV, MSCN, NAM) VALUES (2, 3, 2, 1997);
INSERT INTO GV_HV_CN (MSGV, MSHV, MSCN, NAM) VALUES (3, 2, 2, 1996);

INSERT INTO GV_HDDT (MSGV, MSDT, DIEM) VALUES (1, '97001', 7);
INSERT INTO GV_HDDT (MSGV, MSDT, DIEM) VALUES (2, '97002', 8);
INSERT INTO GV_HDDT (MSGV, MSDT, DIEM) VALUES (3, '97003', 9);
INSERT INTO GV_HDDT (MSGV, MSDT, DIEM) VALUES (4, '97004', 8.5);
INSERT INTO GV_HDDT (MSGV, MSDT, DIEM) VALUES (5, '97005', 7);

INSERT INTO GV_PBDT (MSGV, MSDT, DIEM) VALUES (1, '97005', 5);
INSERT INTO GV_PBDT (MSGV, MSDT, DIEM) VALUES (2, '97001', 7);
INSERT INTO GV_PBDT (MSGV, MSDT, DIEM) VALUES (5, '97004', 6);
INSERT INTO GV_PBDT (MSGV, MSDT, DIEM) VALUES (4, '97003', 8.5);
INSERT INTO GV_PBDT (MSGV, MSDT, DIEM) VALUES (3, '97002', 8);

INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES (5, '97005', 6);
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES (2, '97005', 5);
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES (4, '97005', 5);
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES (3, '97001', 7);
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES (4, '97001', 8);
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES (3, '97003', 10);
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES (1, '97003', 7);
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES (2, '97004', 8);
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES (3, '97004', 9);
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES (1, '97002', 9);
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES (4, '97002', 6);
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES (5, '97002', 6);


INSERT INTO HOIDONG (MSHD, PHONG, TGBD, NGAYHD, TINHTRANG, MSGVCTHD) VALUES (1, '002', '7:00', TO_DATE('30/10/2020', 'DD/MM/YYYY'), 'Thur', 1);
INSERT INTO HOIDONG (MSHD, PHONG, TGBD, NGAYHD, TINHTRANG, MSGVCTHD) VALUES (2, '102', '7:00', TO_DATE('30/10/2020', 'DD/MM/YYYY'), 'Thur', 2);
INSERT INTO HOIDONG (MSHD, PHONG, TGBD, NGAYHD, TINHTRANG, MSGVCTHD) VALUES (3, '003', '8:00', TO_DATE('30/11/2020', 'DD/MM/YYYY'), 'That', 3);

INSERT INTO HOIDONG_GV (MSHD, MSGV) VALUES (1, 1);
INSERT INTO HOIDONG_GV (MSHD, MSGV) VALUES (1, 2);
INSERT INTO HOIDONG_GV (MSHD, MSGV) VALUES (1, 3);
INSERT INTO HOIDONG_GV (MSHD, MSGV) VALUES (1, 4);
INSERT INTO HOIDONG_GV (MSHD, MSGV) VALUES (2, 3);
INSERT INTO HOIDONG_GV (MSHD, MSGV) VALUES (2, 2);
INSERT INTO HOIDONG_GV (MSHD, MSGV) VALUES (2, 5);
INSERT INTO HOIDONG_GV (MSHD, MSGV) VALUES (2, 4);
INSERT INTO HOIDONG_GV (MSHD, MSGV) VALUES (3, 1);
INSERT INTO HOIDONG_GV (MSHD, MSGV) VALUES (3, 2);
INSERT INTO HOIDONG_GV (MSHD, MSGV) VALUES (3, 3);
INSERT INTO HOIDONG_GV (MSHD, MSGV) VALUES (3, 4);

INSERT INTO HOIDONG_DT (MSHD, MSDT, QUYETDINH) VALUES (1, '97001', 'Duoc');
INSERT INTO HOIDONG_DT (MSHD, MSDT, QUYETDINH) VALUES (1, '97002', 'Duoc');
INSERT INTO HOIDONG_DT (MSHD, MSDT, QUYETDINH) VALUES (2, '97003', 'Khong');
INSERT INTO HOIDONG_DT (MSHD, MSDT, QUYETDINH) VALUES (2, '97004', 'Khong');
INSERT INTO HOIDONG_DT (MSHD, MSDT, QUYETDINH) VALUES (1, '97005', 'Duoc');
INSERT INTO HOIDONG_DT (MSHD, MSDT, QUYETDINH) VALUES (3, '97001', 'Khong');
INSERT INTO HOIDONG_DT (MSHD, MSDT, QUYETDINH) VALUES (3, '97002', 'Duoc');
INSERT INTO HOIDONG_DT (MSHD, MSDT, QUYETDINH) VALUES (3, '97004', 'Khong');
 --Bai 5.1
 --cau1
CREATE SEQUENCE SEQ_HOCHAM
    START WITH 1
    INCREMENT BY 3
    MINVALUE 1
    NOCYCLE
    NOCACHE;
--cau2
CREATE SEQUENCE SEQ_HOCVI
    START WITH 5
    INCREMENT BY 1
    MINVALUE 1
    NOCYCLE
    NOCACHE;
--cau6
CREATE SEQUENCE SEQ_GIAOVIEN
    START WITH 6
    INCREMENT BY 1
    MINVALUE 1
    NOCYCLE
    NOCACHE;
--5.2
--cau1
CREATE OR REPLACE FUNCTION TINHDIEMTRUNGBINHDETAI(p_MSDT IN VARCHAR2)
RETURN NUMBER 
IS
  V_TONGDIEM NUMBER := 0;
  V_SOLUONGDIEM NUMBER := 0;
  V_DIEMTRUNGBINH NUMBER := 0;
BEGIN
    SELECT SUM(DIEM), COUNT(DIEM)
    INTO V_TONGDIEM, V_SOLUONGDIEM
    FROM GV_HDDT
    WHERE MSDT = P_MSDT;
    
    SELECT V_TONGDIEM +NVL(SUM(DIEM), 0 ), V_SOLUONGDIEM + COUNT(DIEM)
    INTO V_TONGDIEM, V_SOLUONGDIEM
    FROM GV_PBDT
    WHERE MSDT = P_MSDT;
    
    SELECT V_TONGDIEM +NVL(SUM(DIEM), 0 ), V_SOLUONGDIEM + COUNT(DIEM)
    INTO V_TONGDIEM, V_SOLUONGDIEM
    FROM GV_UVDT
    WHERE MSDT = P_MSDT;
    
    IF V_SOLUONGDIEM >0 THEN
      V_DIEMTRUNGBINH := V_TONGDIEM / V_SOLUONGDIEM;
    ELSE 
      V_DIEMTRUNGBINH := 0;
    END IF;
    
    RETURN ROUND(V_DIEMTRUNGBINH, 2);
EXCEPTION 
  WHEN OTHERS THEN 
    RETURN 0;
END TINHDIEMTRUNGBINHDETAI;

--cau2


CREATE OR REPLACE FUNCTION XEPLOAI_DETAI(p_MSDT IN VARCHAR2)
RETURN VARCHAR2
IS
  v_diem_hd NUMBER := 0;       
  v_diem_pb NUMBER := 0;      
  v_tong_diem_uv NUMBER := 0;  
  v_so_luong_uv NUMBER := 0;   
  v_dtb NUMBER := 0;           
  v_xep_loai VARCHAR2(10);    
BEGIN
  SELECT NVL(DIEM, 0)
  INTO v_diem_hd
  FROM GV_HDDT
  WHERE MSDT = p_MSDT
  AND ROWNUM = 1;  

  SELECT NVL(DIEM, 0)
  INTO v_diem_pb
  FROM GV_PBDT
  WHERE MSDT = p_MSDT
  AND ROWNUM = 1; 
  
  SELECT NVL(SUM(DIEM), 0), COUNT(DIEM)
  INTO v_tong_diem_uv, v_so_luong_uv
  FROM GV_UVDT
  WHERE MSDT = p_MSDT;

  IF (v_so_luong_uv > 0) THEN
    v_dtb := (v_diem_hd + v_diem_pb + v_tong_diem_uv) / 5;
  ELSE
    v_dtb := (v_diem_hd + v_diem_pb) / 5;  
  END IF;

  IF v_dtb >= 8 AND v_dtb <= 10 THEN
    v_xep_loai := 'Giỏi';
  ELSIF v_dtb >= 7 THEN
    v_xep_loai := 'Khá';
  ELSIF v_dtb >= 5 THEN
    v_xep_loai := 'TB';
  ELSE
    v_xep_loai := 'Kém';
  END IF;

  RETURN v_xep_loai;

EXCEPTION
  WHEN NO_DATA_FOUND THEN
    RETURN 'Kém';  
  WHEN OTHERS THEN
    RETURN 'Kém';  
END XEPLOAI_DETAI;

--cau3

CREATE OR REPLACE FUNCTION DEMSINHVIENDETAI(P_MSDT IN VARCHAR2)
RETURN NUMBER 
IS
  V_SOLUONGSV NUMBER := 0;
BEGIN 
  SELECT COUNT(DISTINCT MASV)
  INTO V_SOLUONGSV
  FROM SINHVIEN_DETAI
  WHERE MSDT = P_MSDT;
  
  RETURN V_SOLUONGSV;
EXCEPTION 
  WHEN NO_DATA_FOUND THEN
    RETURN 0;
  WHEN OTHERS THEN
    RETURN 0;
END DEMSINHVIENDETAI;

CREATE OR REPLACE FUNCTION DEM_LAN_BAOVE(p_MSDT IN VARCHAR2, p_MASV IN VARCHAR2)
RETURN NUMBER
IS
  v_so_lan_bv NUMBER := 0; 
BEGIN
  SELECT COUNT(*)
  INTO v_so_lan_bv
  FROM BAOVE_DETAI  
  WHERE MSDT = p_MSDT
  AND MASV = p_MASV;

  RETURN v_so_lan_bv;

EXCEPTION
  WHEN NO_DATA_FOUND THEN
    RETURN 0;  
  WHEN OTHERS THEN
    RETURN 0;  
END DEM_LAN_BAOVE;

--5.4
--CAU1

CREATE OR REPLACE PROCEDURE THEM_GIANGVIEN (
    p_MSGV IN VARCHAR2,
    p_TENGV IN VARCHAR2,
    p_SODT IN VARCHAR2,
    p_DIACHI IN VARCHAR2,
    p_MSHH IN VARCHAR2,
    p_NAMHHAM IN NUMBER
)
IS
    v_count NUMBER := 0;  
BEGIN
    SELECT COUNT(*)
    INTO v_count
    FROM HOCHAM
    WHERE MSHH = p_MSHH;

    IF v_count = 0 THEN
        RAISE_APPLICATION_ERROR(-20001, 'Lỗi: Mã số học hàm ' || p_MSHH || ' không tồn tại trong bảng HOCHAM.');
    ELSE
        INSERT INTO GIANGVIEN (MSGV, TENGV, SODT, DIACHI, MSHH, NAMHHAM)
        VALUES (p_MSGV, p_TENGV, p_SODT, p_DIACHI, p_MSHH, p_NAMHHAM);
        
        DBMS_OUTPUT.PUT_LINE('Đã thêm giảng viên ' || p_TENGV || ' thành công.');
    END IF;

EXCEPTION
    WHEN DUP_VAL_ON_INDEX THEN
        DBMS_OUTPUT.PUT_LINE('Lỗi: Mã số giảng viên ' || p_MSGV || ' đã tồn tại.');
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Lỗi: ' || SQLERRM);
END THEM_GIANGVIEN;

--CAU2
CREATE OR REPLACE PROCEDURE THEM_GIANGVIEN_KIEMTRA_MSGV (
    p_MSGV IN VARCHAR2,
    p_TENGV IN VARCHAR2,
    p_SODT IN VARCHAR2,
    p_DIACHI IN VARCHAR2,
    p_MSHH IN VARCHAR2,
    p_NAMHHAM IN NUMBER
)
IS
    v_count NUMBER := 0;  
BEGIN
    SELECT COUNT(*)
    INTO v_count
    FROM GIANGVIEN
    WHERE MSGV = p_MSGV;

    IF v_count > 0 THEN
        RAISE_APPLICATION_ERROR(-20002, 'Lỗi: Mã số giảng viên ' || p_MSGV || ' đã tồn tại.');
    ELSE
        INSERT INTO GIANGVIEN (MSGV, TENGV, SODT, DIACHI, MSHH, NAMHHAM)
        VALUES (p_MSGV, p_TENGV, p_SODT, p_DIACHI, p_MSHH, p_NAMHHAM);
        
        DBMS_OUTPUT.PUT_LINE('Đã thêm giảng viên ' || p_TENGV || ' thành công.');
    END IF;

EXCEPTION
    WHEN OTHERS THENA
        DBMS_OUTPUT.PUT_LINE('Lỗi: ' || SQLERRM);
END THEM_GIANGVIEN_KIEMTRA_MSGV;






